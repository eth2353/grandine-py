name: Verify local preset files match canonical upstream

permissions:
  contents: read

on:
  schedule:
    # Runs every 7 days at 01:23
    - cron: "23 1 */7 * *"
  # Allows running the workflow manually in the Actions tab
  workflow_dispatch:

jobs:
  verify-spec-values:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Compare preset files
        shell: bash
        run: |
          set -euo pipefail

          declare -A PRESET_ROOT_URLS=(
            ["mainnet"]="https://raw.githubusercontent.com/ethereum/consensus-specs/master/presets/mainnet/"
            ["minimal"]="https://raw.githubusercontent.com/ethereum/consensus-specs/master/presets/minimal/"
            ["gnosis"]="https://raw.githubusercontent.com/gnosischain/specs/master/consensus/preset/gnosis/"
          )

          PRESET_BASE_DIR="spec/presets"
          HAS_FAILURE=0

          for PRESET_NAME in "${!PRESET_ROOT_URLS[@]}"; do
            ROOT_URL="${PRESET_ROOT_URLS[$PRESET_NAME]}"
            LOCAL_DIR="${PRESET_BASE_DIR}/${PRESET_NAME}"

            echo "Checking preset '${PRESET_NAME}' against '${ROOT_URL}'"

            shopt -s nullglob
            LOCAL_FILES=( "${LOCAL_DIR}"/*.yaml )
            shopt -u nullglob

            if [[ ${#LOCAL_FILES[@]} -eq 0 ]]; then
              echo "ERROR: No .yaml files found in '${LOCAL_DIR}' (unexpected)."
              HAS_FAILURE=1
              continue
            fi

            for LOCAL_PATH in "${LOCAL_FILES[@]}"; do
              FILE_NAME="$(basename "${LOCAL_PATH}")"
              REMOTE_URL="${ROOT_URL}${FILE_NAME}"
              TMP_PATH="/tmp/${PRESET_NAME}-${FILE_NAME}"

              if ! curl -fsSL "${REMOTE_URL}" -o "${TMP_PATH}"; then
                echo "Failed to fetch upstream preset file: ${REMOTE_URL}"
                HAS_FAILURE=1
                continue
              fi

              if ! cmp -s "${LOCAL_PATH}" "${TMP_PATH}"; then
                echo "Mismatch detected in preset '${PRESET_NAME}' file '${FILE_NAME}'!"
                echo "----- DIFF -----"
                diff -u "${LOCAL_PATH}" "${TMP_PATH}" || true
                echo "----------------"
                HAS_FAILURE=1
              else
                echo "${PRESET_NAME}/${FILE_NAME} is up-to-date."
              fi
            done
          done

          exit ${HAS_FAILURE}
